services:
  # Shared backend - always runs
  compare-backend:
    image: nginx:alpine
    volumes:
      - ../nginx/perf-backend.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://127.0.0.1/health"]
      interval: 5s
      timeout: 3s
      retries: 3
    networks:
      - compare-net

  # --- This gateway ---
  gw:
    profiles: ["gw"]
    build:
      context: ../..
      dockerfile: Dockerfile
    volumes:
      - ./configs/gateway-compare.yaml:/app/configs/gateway.yaml:ro
    ports:
      - "8080:8080"
    depends_on:
      compare-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8081/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - compare-net

  # --- Kong (DB-less) ---
  kong:
    profiles: ["kong"]
    image: kong:3.9
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /etc/kong/kong.yaml
      KONG_PROXY_LISTEN: "0.0.0.0:8080"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_STATUS_LISTEN: "0.0.0.0:8100"
      KONG_LOG_LEVEL: warn
      KONG_NGINX_WORKER_PROCESSES: auto
    volumes:
      - ./configs/kong.yaml:/etc/kong/kong.yaml:ro
    ports:
      - "8080:8080"
    depends_on:
      compare-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - compare-net

  # --- KrakenD ---
  krakend:
    profiles: ["krakend"]
    image: devopsfaith/krakend:2.7
    command: ["run", "-c", "/etc/krakend/krakend.json"]
    volumes:
      - ./configs/krakend.json:/etc/krakend/krakend.json:ro
    ports:
      - "8080:8080"
    depends_on:
      compare-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/__health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - compare-net

  # --- Traefik ---
  traefik:
    profiles: ["traefik"]
    image: traefik:v3.3
    volumes:
      - ./configs/traefik/traefik.yaml:/etc/traefik/traefik.yaml:ro
      - ./configs/traefik/dynamic.yaml:/etc/traefik/dynamic.yaml:ro
    ports:
      - "8080:8080"
    depends_on:
      compare-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8082/ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - compare-net

  # --- Tyk (requires Redis) ---
  tyk-redis:
    profiles: ["tyk"]
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - compare-net

  tyk:
    profiles: ["tyk"]
    image: tykio/tyk-gateway:v5.7
    volumes:
      - ./configs/tyk/tyk.conf:/opt/tyk-gateway/tyk.conf:ro
      - ./configs/tyk/apps:/opt/tyk-gateway/apps:ro
    ports:
      - "8080:8080"
    depends_on:
      tyk-redis:
        condition: service_healthy
      compare-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/hello"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - compare-net

  # --- Load generator ---
  hey:
    profiles: ["bench"]
    image: williamyeh/hey
    entrypoint: ["tail", "-f", "/dev/null"]
    depends_on:
      compare-backend:
        condition: service_healthy
    networks:
      - compare-net

networks:
  compare-net:
    driver: bridge
