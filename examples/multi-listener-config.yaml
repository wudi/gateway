# Example configuration demonstrating multi-listener and TCP/UDP proxy support
#
# This configuration sets up:
# 1. HTTP listener on port 8080 for API traffic
# 2. HTTPS listener on port 8443 with TLS termination
# 3. TCP listener on port 3306 for MySQL proxy
# 4. TCP listener on port 5432 with SNI-based routing for PostgreSQL
# 5. UDP listener on port 5353 for DNS forwarding

# Multi-listener configuration
listeners:
  # HTTP listener for API traffic
  - id: "http-main"
    address: ":8080"
    protocol: "http"
    http:
      read_timeout: 30s
      write_timeout: 30s
      idle_timeout: 60s
      max_header_bytes: 1048576  # 1MB

  # HTTPS listener with TLS termination
  - id: "https-main"
    address: ":8443"
    protocol: "http"
    tls:
      enabled: true
      cert_file: "/etc/gateway/certs/server.crt"
      key_file: "/etc/gateway/certs/server.key"
    http:
      read_timeout: 30s
      write_timeout: 30s

  # TCP listener for MySQL proxy (transparent)
  - id: "tcp-mysql"
    address: ":3306"
    protocol: "tcp"
    tcp:
      sni_routing: false
      connect_timeout: 10s
      idle_timeout: 5m
      proxy_protocol: false

  # TCP listener with SNI-based routing for PostgreSQL
  - id: "tcp-postgres-sni"
    address: ":5432"
    protocol: "tcp"
    tcp:
      sni_routing: true
      connect_timeout: 10s
      idle_timeout: 5m

  # UDP listener for DNS forwarding
  - id: "udp-dns"
    address: ":5353"
    protocol: "udp"
    udp:
      session_timeout: 30s
      read_buffer_size: 4096
      write_buffer_size: 4096

# Service registry configuration
registry:
  type: "memory"
  memory:
    api_enabled: true
    api_port: 8082

# HTTP routes (for http listeners)
routes:
  # API route
  - id: "api"
    path: "/api"
    path_prefix: true
    backends:
      - url: "http://api-server-1:9001"
        weight: 2
      - url: "http://api-server-2:9001"
        weight: 1
    timeout: 30s
    retries: 2
    rate_limit:
      enabled: true
      rate: 100
      period: 1m
      burst: 20
      per_ip: true

  # Auth service route
  - id: "auth"
    path: "/auth"
    path_prefix: true
    backends:
      - url: "http://auth-service:9002"
    auth:
      required: true
      methods: ["jwt"]

  # Static files
  - id: "static"
    path: "/static"
    path_prefix: true
    backends:
      - url: "http://cdn-server:9003"
    transform:
      response:
        headers:
          add:
            "Cache-Control": "public, max-age=86400"

# TCP routes (for tcp listeners)
tcp_routes:
  # MySQL proxy route
  - id: "mysql-primary"
    listener: "tcp-mysql"
    match:
      source_cidr:
        - "10.0.0.0/8"
        - "192.168.0.0/16"
    backends:
      - url: "tcp://mysql-primary:3306"
        weight: 1

  # PostgreSQL with SNI routing
  - id: "postgres-prod"
    listener: "tcp-postgres-sni"
    match:
      sni:
        - "postgres-prod.example.com"
        - "*.prod.example.com"
    backends:
      - url: "tcp://postgres-prod:5432"

  - id: "postgres-dev"
    listener: "tcp-postgres-sni"
    match:
      sni:
        - "postgres-dev.example.com"
        - "*.dev.example.com"
    backends:
      - url: "tcp://postgres-dev:5432"

# UDP routes (for udp listeners)
udp_routes:
  # DNS forwarding to public DNS
  - id: "dns-forward"
    listener: "udp-dns"
    backends:
      - url: "udp://8.8.8.8:53"
        weight: 1
      - url: "udp://8.8.4.4:53"
        weight: 1

# Authentication configuration
authentication:
  jwt:
    enabled: true
    secret: "${JWT_SECRET}"
    algorithm: "HS256"
    issuer: "my-app"
  api_key:
    enabled: true
    header: "X-API-Key"
    keys:
      - key: "${API_KEY_1}"
        client_id: "client-1"
        name: "Production Client"

# Logging configuration
logging:
  format: '$remote_addr - [$time_iso8601] "$request_method $request_uri" $status $body_bytes_sent "$http_user_agent" $response_time'
  level: "info"
  output: "stdout"

# Admin API configuration
admin:
  enabled: true
  port: 8081
